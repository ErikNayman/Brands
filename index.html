<!--
  Brands.html — Sidebar UI for Google Sheets (Apps Script HtmlService)

  Требует наличия серверных функций в Apps Script проекте:
    - BrandSearch_getOptions()
    - BrandSearch_searchBrands(criteria)
    - BrandSearch_gotoRow(rowNumber)

  Логика совпадений:
    - Между группами (Price Point, Categories, Gender, Key Categories, Size Range, Origin, Style, Key Words): AND
    - Внутри групп с множественным выбором (Categories/Gender/Key Categories/Size Range/Style/Key Words): ALL (должны присутствовать ВСЕ выбранные)
    - Для Price Point и Origin (если выбрано несколько): ANY (подойдёт любой из выбранных)
-->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #ffffff;
        --text: #111;
        --muted: #666;
        --border: #e6e6e6;
        --chip-bg: #eef3fd;
        --chip-border: #d6e4ff;
        --primary: #1a73e8;
        --danger: #e53935;
      }

      body {
        font-family: Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 12px;
        margin: 0;
      }

      h2 {
        margin: 0 0 10px 0;
        font-size: 16px;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
        margin: 6px 0 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .field {
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 10px;
      }

      .label {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .row {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }

      input[type="text"] {
        flex: 1;
        min-width: 170px;
        padding: 7px 9px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
      }

      button {
        padding: 7px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #f7f7f7;
        cursor: pointer;
        user-select: none;
      }

      button.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      button.danger {
        background: #fff;
        border-color: var(--danger);
        color: var(--danger);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .chip {
        background: var(--chip-bg);
        border: 1px solid var(--chip-border);
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .chip a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
      }

      .small {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      #status {
        margin: 10px 0 0;
        font-size: 12px;
        color: #444;
        white-space: pre-wrap;
      }

      #resultsWrap {
        margin-top: 12px;
      }

      .count {
        font-weight: 700;
        margin-bottom: 6px;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      .tableWrap {
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
      }

      th, td {
        border-bottom: 1px solid #eee;
        padding: 6px 8px;
        white-space: nowrap;
        vertical-align: top;
      }

      th {
        position: sticky;
        top: 0;
        background: #fafafa;
        z-index: 1;
        text-align: left;
      }

      .sep {
        height: 1px;
        background: #eee;
        margin: 10px 0;
      }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
      }

      .filtersSummary {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0 0;
      }

      .link {
        color: var(--primary);
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <h2>Brands — поиск</h2>

    <div class="muted">
      Вы выбираете параметры и нажимаете <b>Найти</b>.<br />
      Результат: список брендов (строки A–AA) в одной строке на бренд.<br />
      Совпадение: <b>все</b> группы фильтров (AND). Внутри групп с множественным выбором — <b>ALL</b> (все выбранные должны присутствовать).<br />
      Для <b>Price Point</b> и <b>Origin</b>: если выбрано несколько — подходит любой (ANY).
    </div>

    <div class="grid">

      <div class="field">
        <div class="label">Price Point</div>
        <div class="row">
          <input id="inPrice" type="text" list="dlPrice" placeholder="Начните ввод…" />
          <button onclick="addTag('pricePoints')">Добавить</button>
        </div>
        <datalist id="dlPrice"></datalist>
        <div id="chips_pricePoints" class="chips"></div>
        <div class="small">Можно добавить несколько: подходит любой из выбранных (ANY).</div>
      </div>

      <div class="field">
        <div class="label">Categories</div>
        <div class="row">
          <input id="inCategories" type="text" list="dlCategories" placeholder="Начните ввод…" />
          <button onclick="addTag('categories')">Добавить</button>
        </div>
        <datalist id="dlCategories"></datalist>
        <div id="chips_categories" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="field">
        <div class="label">Gender (s)</div>
        <div class="row">
          <input id="inGenders" type="text" list="dlGenders" placeholder="Начните ввод…" />
          <button onclick="addTag('genders')">Добавить</button>
        </div>
        <datalist id="dlGenders"></datalist>
        <div id="chips_genders" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="field">
        <div class="label">Key Categories</div>
        <div class="row">
          <input id="inKeyCategories" type="text" list="dlKeyCategories" placeholder="Начните ввод…" />
          <button onclick="addTag('keyCategories')">Добавить</button>
        </div>
        <datalist id="dlKeyCategories"></datalist>
        <div id="chips_keyCategories" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="field">
        <div class="label">Size Range</div>
        <div class="row">
          <input id="inSizes" type="text" list="dlSizes" placeholder="Начните ввод…" />
          <button onclick="addTag('sizeRanges')">Добавить</button>
        </div>
        <datalist id="dlSizes"></datalist>
        <div id="chips_sizeRanges" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="field">
        <div class="label">Origin</div>
        <div class="row">
          <input id="inOrigins" type="text" list="dlOrigins" placeholder="Начните ввод…" />
          <button onclick="addTag('origins')">Добавить</button>
        </div>
        <datalist id="dlOrigins"></datalist>
        <div id="chips_origins" class="chips"></div>
        <div class="small">Можно добавить несколько: подходит любой из выбранных (ANY).</div>
      </div>

      <div class="field">
        <div class="label">Distinctive Style</div>
        <div class="row">
          <input id="inStyles" type="text" list="dlStyles" placeholder="Начните ввод…" />
          <button onclick="addTag('styles')">Добавить</button>
        </div>
        <datalist id="dlStyles"></datalist>
        <div id="chips_styles" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="field">
        <div class="label">Key Words</div>
        <div class="row">
          <input id="inKeywords" type="text" list="dlKeywords" placeholder="Начните ввод…" />
          <button onclick="addTag('keywords')">Добавить</button>
        </div>
        <datalist id="dlKeywords"></datalist>
        <div id="chips_keywords" class="chips"></div>
        <div class="small">Если выбрано несколько: должны присутствовать все (ALL).</div>
      </div>

      <div class="sep"></div>

      <div class="row" style="gap:8px;">
        <button id="btnSearch" class="primary" onclick="runSearch()">Найти</button>
        <button class="danger" onclick="clearAll()">Очистить</button>
      </div>

      <div id="status"></div>

      <div id="resultsWrap"></div>
    </div>

    <script>
      // ---------- State ----------
      const state = {
        pricePoints: [],
        categories: [],
        genders: [],
        keyCategories: [],
        sizeRanges: [],
        origins: [],
        styles: [],
        keywords: []
      };

      const fields = {
        pricePoints:   { inputId: 'inPrice',         dlId: 'dlPrice',         chipsId: 'chips_pricePoints' },
        categories:    { inputId: 'inCategories',    dlId: 'dlCategories',    chipsId: 'chips_categories' },
        genders:       { inputId: 'inGenders',       dlId: 'dlGenders',       chipsId: 'chips_genders' },
        keyCategories: { inputId: 'inKeyCategories', dlId: 'dlKeyCategories', chipsId: 'chips_keyCategories' },
        sizeRanges:    { inputId: 'inSizes',         dlId: 'dlSizes',         chipsId: 'chips_sizeRanges' },
        origins:       { inputId: 'inOrigins',       dlId: 'dlOrigins',       chipsId: 'chips_origins' },
        styles:        { inputId: 'inStyles',        dlId: 'dlStyles',        chipsId: 'chips_styles' },
        keywords:      { inputId: 'inKeywords',      dlId: 'dlKeywords',      chipsId: 'chips_keywords' }
      };

      // canonical mapping: normalized -> canonical
      let optionMaps = {};

      function norm(s) {
        return String(s || '')
          .replace(/\u00A0/g, ' ')
          .replace(/[’]/g, "'")
          .trim()
          .toLowerCase();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
      }

      function escapeJs(s) {
        return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      }

      function setStatus(msg) {
        document.getElementById('status').textContent = msg || '';
      }

      function buildDatalist(dlId, options) {
        const dl = document.getElementById(dlId);
        dl.innerHTML = '';
        (options || []).forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          dl.appendChild(opt);
        });
      }

      function buildMap(options) {
        const m = {};
        (options || []).forEach(v => m[norm(v)] = v);
        return m;
      }

      function renderChips(fieldKey) {
        const chips = document.getElementById(fields[fieldKey].chipsId);
        chips.innerHTML = '';
        state[fieldKey].forEach(v => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.innerHTML = `<span>${escapeHtml(v)}</span>
                            <a href="#" onclick="removeTag('${fieldKey}','${escapeJs(v)}');return false;">×</a>`;
          chips.appendChild(chip);
        });
      }

      function addTag(fieldKey) {
        const input = document.getElementById(fields[fieldKey].inputId);
        const raw = input.value;
        if (!raw) return;

        const map = optionMaps[fieldKey] || {};
        const canon = map[norm(raw)];

        if (!canon) {
          setStatus(`Значение не распознано: "${raw}". Выберите из выпадающего списка.`);
          return;
        }

        if (!state[fieldKey].includes(canon)) {
          state[fieldKey].push(canon);
          renderChips(fieldKey);
        }

        input.value = '';
        setStatus('');
      }

      function removeTag(fieldKey, value) {
        state[fieldKey] = state[fieldKey].filter(v => v !== value);
        renderChips(fieldKey);
      }

      function clearAll() {
        Object.keys(state).forEach(k => state[k] = []);
        Object.keys(fields).forEach(renderChips);
        document.getElementById('resultsWrap').innerHTML = '';
        setStatus('Фильтры очищены.');
      }

      function buildFiltersSummary() {
        const pairs = [
          ['Price', state.pricePoints],
          ['Categories', state.categories],
          ['Gender', state.genders],
          ['KeyCat', state.keyCategories],
          ['Size', state.sizeRanges],
          ['Origin', state.origins],
          ['Style', state.styles],
          ['Keywords', state.keywords]
        ];

        const pills = pairs
          .filter(([_, arr]) => arr && arr.length)
          .map(([name, arr]) => `<span class="pill">${escapeHtml(name)}: ${escapeHtml(arr.join(', '))}</span>`)
          .join(' ');

        return pills ? `<div class="filtersSummary">${pills}</div>` : '';
      }

      function runSearch() {
        if (!google || !google.script || !google.script.run) {
          setStatus('Эта страница должна быть открыта внутри Google Sheets (Apps Script sidebar).');
          return;
        }

        document.getElementById('btnSearch').disabled = true;
        setStatus('Поиск…');
        document.getElementById('resultsWrap').innerHTML = '';

        // Отправляем критерии на сервер
        const payload = {
          pricePoints: state.pricePoints,
          categories: state.categories,
          genders: state.genders,
          keyCategories: state.keyCategories,
          sizeRanges: state.sizeRanges,
          origins: state.origins,
          styles: state.styles,
          keywords: state.keywords
        };

        google.script.run
          .withSuccessHandler(res => {
            document.getElementById('btnSearch').disabled = false;
            setStatus('');
            renderResults(res);
          })
          .withFailureHandler(err => {
            document.getElementById('btnSearch').disabled = false;
            setStatus('Ошибка: ' + (err && err.message ? err.message : err));
          })
          .BrandSearch_searchBrands(payload);
      }

      function gotoRow(rowNum) {
        google.script.run.BrandSearch_gotoRow(rowNum);
      }

      function renderResults(res) {
        const wrap = document.getElementById('resultsWrap');

        const summary = buildFiltersSummary();

        if (!res || !res.rows || res.rows.length === 0) {
          wrap.innerHTML = summary + `<div class="hint">Ничего не найдено по выбранным фильтрам.</div>`;
          return;
        }

        const headers = res.headers || [];
        const rows = res.rows || [];

        let html = summary;
        html += `<div class="count">Найдено: ${rows.length}</div>`;
        html += `<div class="tableWrap"><table><thead><tr>`;

        headers.forEach(h => { html += `<th>${escapeHtml(h)}</th>`; });
        html += `</tr></thead><tbody>`;

        rows.forEach(r => {
          html += `<tr>`;
          r.forEach((cell, idx) => {
            if (idx === 0) {
              html += `<td><a class="link" href="#" onclick="gotoRow(${Number(cell)});return false;">${Number(cell)}</a></td>`;
            } else {
              html += `<td>${escapeHtml(cell)}</td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        wrap.innerHTML = html;
      }

      function init() {
        if (!google || !google.script || !google.script.run) {
          setStatus('Эта страница должна быть открыта внутри Google Sheets (Apps Script sidebar).');
          return;
        }

        setStatus('Загрузка списков…');

        google.script.run
          .withSuccessHandler(opts => {
            // datalists
            buildDatalist(fields.pricePoints.dlId, opts.pricePoints || []);
            buildDatalist(fields.categories.dlId, opts.categories || []);
            buildDatalist(fields.genders.dlId, opts.genders || []);
            buildDatalist(fields.keyCategories.dlId, opts.keyCategories || []);
            buildDatalist(fields.sizeRanges.dlId, opts.sizeRanges || []);
            buildDatalist(fields.origins.dlId, opts.origins || []);
            buildDatalist(fields.styles.dlId, opts.styles || []);
            buildDatalist(fields.keywords.dlId, opts.keywords || []);

            // maps for strict selection
            optionMaps = {
              pricePoints: buildMap(opts.pricePoints || []),
              categories: buildMap(opts.categories || []),
              genders: buildMap(opts.genders || []),
              keyCategories: buildMap(opts.keyCategories || []),
              sizeRanges: buildMap(opts.sizeRanges || []),
              origins: buildMap(opts.origins || []),
              styles: buildMap(opts.styles || []),
              keywords: buildMap(opts.keywords || [])
            };

            // Enter -> Add
            Object.keys(fields).forEach(k => {
              const el = document.getElementById(fields[k].inputId);
              el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  addTag(k);
                }
              });
            });

            setStatus('Готово. Выберите параметры и нажмите “Найти”.');
          })
          .withFailureHandler(err => {
            setStatus('Ошибка загрузки списков: ' + (err && err.message ? err.message : err));
          })
          .BrandSearch_getOptions();
      }

      window.addEventListener('load', init);
    </script>
  </body>
</html>
