<!--
  Brands.html — Sidebar UI for Google Sheets (Apps Script HtmlService)

  Требует наличия серверных функций в Apps Script проекте:
    - BrandSearch_getOptions()
    - BrandSearch_searchBrands(criteria)
    - BrandSearch_gotoRow(rowNumber)

  Изменения по запросу:
    - Для каждой переменной сделан выпадающий список (dropdown)
    - Можно выбрать несколько значений (multi-select через чекбоксы)
    - Есть поиск внутри dropdown (важно для Key Words)
    - Выбранные значения отображаются чипами, можно удалять крестиком

  Логика совпадений (как раньше):
    - Между группами: AND
    - Внутри групп с множественным выбором: ALL (должны присутствовать ВСЕ выбранные)
    - Для Price Point и Origin (если выбрано несколько): ANY (подойдёт любой из выбранных)
-->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <style>
      :root {
        --bg: #ffffff;
        --text: #111;
        --muted: #666;
        --border: #e6e6e6;
        --chip-bg: #eef3fd;
        --chip-border: #d6e4ff;
        --primary: #1a73e8;
        --danger: #e53935;
      }

      body {
        font-family: Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 12px;
        margin: 0;
      }

      h2 {
        margin: 0 0 10px 0;
        font-size: 16px;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.35;
        margin: 6px 0 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .field {
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 10px;
      }

      .label {
        font-weight: 600;
        margin-bottom: 6px;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        padding: 7px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #f7f7f7;
        cursor: pointer;
        user-select: none;
      }

      button.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      button.danger {
        background: #fff;
        border-color: var(--danger);
        color: var(--danger);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .chip {
        background: var(--chip-bg);
        border: 1px solid var(--chip-border);
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .chip a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 700;
      }

      .small {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      #status {
        margin: 10px 0 0;
        font-size: 12px;
        color: #444;
        white-space: pre-wrap;
      }

      #resultsWrap {
        margin-top: 12px;
      }

      .count {
        font-weight: 700;
        margin-bottom: 6px;
      }

      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
      }

      .tableWrap {
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
      }

      th, td {
        border-bottom: 1px solid #eee;
        padding: 6px 8px;
        white-space: nowrap;
        vertical-align: top;
      }

      th {
        position: sticky;
        top: 0;
        background: #fafafa;
        z-index: 1;
        text-align: left;
      }

      .sep {
        height: 1px;
        background: #eee;
        margin: 10px 0;
      }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
      }

      .filtersSummary {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 8px 0 0;
      }

      .link {
        color: var(--primary);
        text-decoration: none;
      }

      /* ---------- Multi-select dropdown ---------- */
      .ms {
        position: relative;
      }

      .ms-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        user-select: none;
      }

      .ms-header .ms-text {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #111;
        font-size: 12px;
      }

      .ms-header .ms-caret {
        color: #777;
        font-size: 12px;
      }

      .ms-panel {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 6px);
        z-index: 999;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,.10);
        padding: 8px;
      }

      .ms.open .ms-panel { display: block; }

      .ms-search {
        width: 100%;
        box-sizing: border-box;
        padding: 7px 9px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        font-size: 12px;
      }

      .ms-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }

      .ms-actions .left {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }

      .mini {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 999px;
      }

      .ms-options {
        margin-top: 8px;
        max-height: 220px;
        overflow: auto;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 6px;
      }

      .ms-opt {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 6px;
        border-radius: 6px;
        cursor: pointer;
      }

      .ms-opt:hover { background: #fafafa; }

      .ms-opt input {
        margin-top: 2px;
      }

      .ms-opt span {
        font-size: 12px;
        line-height: 1.25;
        word-break: break-word;
      }
    </style>
  </head>

  <body>
    <h2>Brands — поиск</h2>

    <div class="muted">
      Вы выбираете параметры и нажимаете <b>Найти</b>.<br />
      Результат: список брендов (строки A–AA) — одна строка на бренд.<br />
      Совпадение: <b>все</b> группы фильтров (AND). Внутри групп с множественным выбором — <b>ALL</b> (все выбранные должны присутствовать).<br />
      Для <b>Price Point</b> и <b>Origin</b>: если выбрано несколько — подходит любой (ANY).
    </div>

    <div class="grid">

      <!-- Price Point -->
      <div class="field">
        <div class="label">Price Point</div>
        <div class="ms" id="ms_pricePoints">
          <div class="ms-header" id="ms_header_pricePoints" onclick="msToggle('pricePoints')">
            <div class="ms-text" id="ms_text_pricePoints">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_pricePoints" placeholder="Поиск…" oninput="msFilter('pricePoints', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_pricePoints">0 выбрано</span></div>
              <button class="mini" onclick="msClear('pricePoints');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_pricePoints"></div>
          </div>
        </div>
        <div id="chips_pricePoints" class="chips"></div>
        <div class="small">Можно выбрать несколько — подходит любой (ANY).</div>
      </div>

      <!-- Categories -->
      <div class="field">
        <div class="label">Categories</div>
        <div class="ms" id="ms_categories">
          <div class="ms-header" id="ms_header_categories" onclick="msToggle('categories')">
            <div class="ms-text" id="ms_text_categories">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_categories" placeholder="Поиск…" oninput="msFilter('categories', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_categories">0 выбрано</span></div>
              <button class="mini" onclick="msClear('categories');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_categories"></div>
          </div>
        </div>
        <div id="chips_categories" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <!-- Gender(s) -->
      <div class="field">
        <div class="label">Gender (s)</div>
        <div class="ms" id="ms_genders">
          <div class="ms-header" id="ms_header_genders" onclick="msToggle('genders')">
            <div class="ms-text" id="ms_text_genders">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_genders" placeholder="Поиск…" oninput="msFilter('genders', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_genders">0 выбрано</span></div>
              <button class="mini" onclick="msClear('genders');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_genders"></div>
          </div>
        </div>
        <div id="chips_genders" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <!-- Key Categories -->
      <div class="field">
        <div class="label">Key Categories</div>
        <div class="ms" id="ms_keyCategories">
          <div class="ms-header" id="ms_header_keyCategories" onclick="msToggle('keyCategories')">
            <div class="ms-text" id="ms_text_keyCategories">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_keyCategories" placeholder="Поиск…" oninput="msFilter('keyCategories', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_keyCategories">0 выбрано</span></div>
              <button class="mini" onclick="msClear('keyCategories');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_keyCategories"></div>
          </div>
        </div>
        <div id="chips_keyCategories" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <!-- Size Range -->
      <div class="field">
        <div class="label">Size Range</div>
        <div class="ms" id="ms_sizeRanges">
          <div class="ms-header" id="ms_header_sizeRanges" onclick="msToggle('sizeRanges')">
            <div class="ms-text" id="ms_text_sizeRanges">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_sizeRanges" placeholder="Поиск…" oninput="msFilter('sizeRanges', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_sizeRanges">0 выбрано</span></div>
              <button class="mini" onclick="msClear('sizeRanges');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_sizeRanges"></div>
          </div>
        </div>
        <div id="chips_sizeRanges" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <!-- Origin -->
      <div class="field">
        <div class="label">Origin</div>
        <div class="ms" id="ms_origins">
          <div class="ms-header" id="ms_header_origins" onclick="msToggle('origins')">
            <div class="ms-text" id="ms_text_origins">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_origins" placeholder="Поиск…" oninput="msFilter('origins', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_origins">0 выбрано</span></div>
              <button class="mini" onclick="msClear('origins');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_origins"></div>
          </div>
        </div>
        <div id="chips_origins" class="chips"></div>
        <div class="small">Можно выбрать несколько — подходит любой (ANY).</div>
      </div>

      <!-- Distinctive Style -->
      <div class="field">
        <div class="label">Distinctive Style</div>
        <div class="ms" id="ms_styles">
          <div class="ms-header" id="ms_header_styles" onclick="msToggle('styles')">
            <div class="ms-text" id="ms_text_styles">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_styles" placeholder="Поиск…" oninput="msFilter('styles', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_styles">0 выбрано</span></div>
              <button class="mini" onclick="msClear('styles');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_styles"></div>
          </div>
        </div>
        <div id="chips_styles" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <!-- Key Words -->
      <div class="field">
        <div class="label">Key Words</div>
        <div class="ms" id="ms_keywords">
          <div class="ms-header" id="ms_header_keywords" onclick="msToggle('keywords')">
            <div class="ms-text" id="ms_text_keywords">Выбрать…</div>
            <div class="ms-caret">▾</div>
          </div>
          <div class="ms-panel" onclick="event.stopPropagation()">
            <input class="ms-search" id="ms_search_keywords" placeholder="Поиск…" oninput="msFilter('keywords', this.value)" />
            <div class="ms-actions">
              <div class="left"><span id="ms_count_keywords">0 выбрано</span></div>
              <button class="mini" onclick="msClear('keywords');event.stopPropagation();">Clear</button>
            </div>
            <div class="ms-options" id="opts_keywords"></div>
          </div>
        </div>
        <div id="chips_keywords" class="chips"></div>
        <div class="small">Если выбрано несколько — должны присутствовать все (ALL).</div>
      </div>

      <div class="sep"></div>

      <div class="row" style="gap:8px;">
        <button id="btnSearch" class="primary" onclick="runSearch()">Найти</button>
        <button class="danger" onclick="clearAll()">Очистить</button>
      </div>

      <div id="status"></div>
      <div id="resultsWrap"></div>
    </div>

    <script>
      // ---------- State ----------
      const state = {
        pricePoints: [],
        categories: [],
        genders: [],
        keyCategories: [],
        sizeRanges: [],
        origins: [],
        styles: [],
        keywords: []
      };

      const msKeys = ['pricePoints','categories','genders','keyCategories','sizeRanges','origins','styles','keywords'];

      function norm(s) {
        return String(s || '')
          .replace(/\u00A0/g, ' ')
          .replace(/[’]/g, "'")
          .trim()
          .toLowerCase();
      }

      function setStatus(msg) {
        document.getElementById('status').textContent = msg || '';
      }

      function closeAllExcept(key) {
        msKeys.forEach(k => {
          if (k !== key) document.getElementById(`ms_${k}`).classList.remove('open');
        });
      }

      function msToggle(key) {
        const el = document.getElementById(`ms_${key}`);
        const willOpen = !el.classList.contains('open');
        closeAllExcept(key);
        el.classList.toggle('open', willOpen);

        if (willOpen) {
          const searchEl = document.getElementById(`ms_search_${key}`);
          if (searchEl) searchEl.focus();
        }
      }

      function msCloseAll() {
        msKeys.forEach(k => document.getElementById(`ms_${k}`).classList.remove('open'));
      }

      document.addEventListener('click', (e) => {
        // клик вне dropdown — закрыть
        if (!e.target.closest('.ms')) msCloseAll();
      });

      function updateHeader(key) {
        const textEl = document.getElementById(`ms_text_${key}`);
        const countEl = document.getElementById(`ms_count_${key}`);
        const n = state[key].length;

        if (countEl) countEl.textContent = `${n} выбрано`;

        if (!textEl) return;
        if (n === 0) textEl.textContent = 'Выбрать…';
        else if (n === 1) textEl.textContent = state[key][0];
        else textEl.textContent = `${n} выбрано`;
      }

      function renderChips(key) {
        const chipsEl = document.getElementById(`chips_${key}`);
        chipsEl.innerHTML = '';

        state[key].forEach(v => {
          const chip = document.createElement('span');
          chip.className = 'chip';

          const txt = document.createElement('span');
          txt.textContent = v;

          const a = document.createElement('a');
          a.href = '#';
          a.textContent = '×';
          a.addEventListener('click', (ev) => {
            ev.preventDefault();
            msUncheck(key, v);
          });

          chip.appendChild(txt);
          chip.appendChild(a);
          chipsEl.appendChild(chip);
        });
      }

      function msSyncFromCheckboxes(key) {
        const optsWrap = document.getElementById(`opts_${key}`);
        const boxes = optsWrap.querySelectorAll('input[type="checkbox"]');
        state[key] = Array.from(boxes).filter(b => b.checked).map(b => b.value);

        updateHeader(key);
        renderChips(key);
      }

      function msUncheck(key, value) {
        const optsWrap = document.getElementById(`opts_${key}`);
        const boxes = optsWrap.querySelectorAll('input[type="checkbox"]');
        boxes.forEach(b => {
          if (b.value === value) b.checked = false;
        });
        msSyncFromCheckboxes(key);
      }

      function msClear(key) {
        const optsWrap = document.getElementById(`opts_${key}`);
        const boxes = optsWrap.querySelectorAll('input[type="checkbox"]');
        boxes.forEach(b => (b.checked = false));
        msSyncFromCheckboxes(key);
        // чистим поиск
        const s = document.getElementById(`ms_search_${key}`);
        if (s) { s.value = ''; msFilter(key, ''); }
      }

      function msFilter(key, query) {
        const q = norm(query);
        const optsWrap = document.getElementById(`opts_${key}`);
        const labels = optsWrap.querySelectorAll('.ms-opt');

        labels.forEach(lbl => {
          const hay = lbl.dataset.norm || '';
          lbl.style.display = (q === '' || hay.includes(q)) ? 'flex' : 'none';
        });
      }

      function buildOptions(key, options) {
        const optsWrap = document.getElementById(`opts_${key}`);
        optsWrap.innerHTML = '';

        (options || []).forEach(v => {
          const label = document.createElement('label');
          label.className = 'ms-opt';
          label.dataset.norm = norm(v);

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = v;
          cb.addEventListener('change', () => msSyncFromCheckboxes(key));

          const span = document.createElement('span');
          span.textContent = v;

          label.appendChild(cb);
          label.appendChild(span);
          optsWrap.appendChild(label);
        });

        // initial header
        updateHeader(key);
        renderChips(key);
      }

      function clearAll() {
        msKeys.forEach(k => msClear(k));
        document.getElementById('resultsWrap').innerHTML = '';
        setStatus('Фильтры очищены.');
      }

      function buildFiltersSummary() {
        const pairs = [
          ['Price', state.pricePoints],
          ['Categories', state.categories],
          ['Gender', state.genders],
          ['KeyCat', state.keyCategories],
          ['Size', state.sizeRanges],
          ['Origin', state.origins],
          ['Style', state.styles],
          ['Keywords', state.keywords]
        ];

        const pills = pairs
          .filter(([_, arr]) => arr && arr.length)
          .map(([name, arr]) => `<span class="pill">${escapeHtml(name)}: ${escapeHtml(arr.join(', '))}</span>`)
          .join(' ');

        return pills ? `<div class="filtersSummary">${pills}</div>` : '';
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
      }

      function runSearch() {
        if (!google || !google.script || !google.script.run) {
          setStatus('Эта страница должна быть открыта внутри Google Sheets (Apps Script sidebar).');
          return;
        }

        document.getElementById('btnSearch').disabled = true;
        setStatus('Поиск…');
        document.getElementById('resultsWrap').innerHTML = '';

        const payload = {
          pricePoints: state.pricePoints,
          categories: state.categories,
          genders: state.genders,
          keyCategories: state.keyCategories,
          sizeRanges: state.sizeRanges,
          origins: state.origins,
          styles: state.styles,
          keywords: state.keywords
        };

        google.script.run
          .withSuccessHandler(res => {
            document.getElementById('btnSearch').disabled = false;
            setStatus('');
            renderResults(res);
          })
          .withFailureHandler(err => {
            document.getElementById('btnSearch').disabled = false;
            setStatus('Ошибка: ' + (err && err.message ? err.message : err));
          })
          .BrandSearch_searchBrands(payload);
      }

      function gotoRow(rowNum) {
        google.script.run.BrandSearch_gotoRow(rowNum);
      }

      function renderResults(res) {
        const wrap = document.getElementById('resultsWrap');
        const summary = buildFiltersSummary();

        if (!res || !res.rows || res.rows.length === 0) {
          wrap.innerHTML = summary + `<div class="hint">Ничего не найдено по выбранным фильтрам.</div>`;
          return;
        }

        const headers = res.headers || [];
        const rows = res.rows || [];

        let html = summary;
        html += `<div class="count">Найдено: ${rows.length}</div>`;
        html += `<div class="tableWrap"><table><thead><tr>`;

        headers.forEach(h => { html += `<th>${escapeHtml(h)}</th>`; });
        html += `</tr></thead><tbody>`;

        rows.forEach(r => {
          html += `<tr>`;
          r.forEach((cell, idx) => {
            if (idx === 0) {
              html += `<td><a class="link" href="#" onclick="gotoRow(${Number(cell)});return false;">${Number(cell)}</a></td>`;
            } else {
              html += `<td>${escapeHtml(cell)}</td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        wrap.innerHTML = html;
      }

      function init() {
        if (!google || !google.script || !google.script.run) {
          setStatus('Эта страница должна быть открыта внутри Google Sheets (Apps Script sidebar).');
          return;
        }

        setStatus('Загрузка списков…');

        google.script.run
          .withSuccessHandler(opts => {
            buildOptions('pricePoints', opts.pricePoints || []);
            buildOptions('categories', opts.categories || []);
            buildOptions('genders', opts.genders || []);
            buildOptions('keyCategories', opts.keyCategories || []);
            buildOptions('sizeRanges', opts.sizeRanges || []);
            buildOptions('origins', opts.origins || []);
            buildOptions('styles', opts.styles || []);
            buildOptions('keywords', opts.keywords || []);

            setStatus('Готово. Выберите параметры и нажмите “Найти”.');
          })
          .withFailureHandler(err => {
            setStatus('Ошибка загрузки списков: ' + (err && err.message ? err.message : err));
          })
          .BrandSearch_getOptions();
      }

      window.addEventListener('load', init);
    </script>
  </body>
</html>
